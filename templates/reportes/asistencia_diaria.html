{% extends 'base.html' %}
{% block title %}Asistencia Diaria{% endblock %}

{% block content %}
<div class="card shadow-sm border-info">
  <div class="card-header bg-gradient bg-info text-white d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-calendar-check-fill me-2"></i> Asistencia diaria</h5>
    <span class="badge bg-light text-dark px-3 py-2">Panel actualizado cada 30 segundos</span>
  </div>
  <div class="card-body">

    <!-- Filtro -->
    <form method="get" class="row g-3 mb-4">
      <div class="col-md-4">
        <label for="fecha" class="form-label"><i class="bi bi-calendar-date me-1"></i> Fecha</label>
        <input type="date" class="form-control border-info" id="fecha" name="fecha" value="{{ fecha }}">
      </div>
      <div class="col-md-4">
        <label for="docente" class="form-label"><i class="bi bi-person-badge me-1"></i> Docente</label>
        <input type="text" class="form-control border-info" id="docente" name="docente" placeholder="Nombre o cédula">
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-info w-100 shadow-sm">
          <i class="bi bi-search me-1"></i> Buscar
        </button>
      </div>
    </form>

    <!-- Importación -->
    <div class="p-3 mb-4 bg-light border rounded">
      <h6 class="mb-3"><i class="bi bi-upload me-2"></i>Importar asistencia desde archivo JSON</h6>
      <form action="{{ url_for('asistencia.importar_json') }}" method="POST" enctype="multipart/form-data" class="row g-3">
        <div class="col-md-8">
          <input type="file" name="archivo_json" accept=".json" class="form-control border-success" required>
        </div>
        <div class="col-md-4 d-grid">
          <button type="submit" class="btn btn-success shadow-sm">
            <i class="bi bi-cloud-upload-fill me-1"></i> Subir y registrar
          </button>
        </div>
      </form>
    </div>

    <!-- Tabla -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle table-striped">
        <thead class="table-info text-center">
          <tr>
            <th><i class="bi bi-person-fill"></i> Docente</th>
            <th><i class="bi bi-calendar-event"></i> Fecha</th>
            <th><i class="bi bi-door-open"></i> Entrada</th>
            <th><i class="bi bi-door-closed"></i> Salida</th>
            <th><i class="bi bi-clock-history"></i> Jornada</th>
          </tr>
        </thead>
        <tbody>
          {% for r in resultados %}
            <tr id="{{ r.fila_id }}" class="text-center">
              <td>{{ r.docente.nombre }}</td>
              <td>{{ r.fecha.strftime('%d/%m/%Y') }}</td>
              <td class="text-success fw-semibold">{{ r.hora_entrada.strftime('%H:%M') if r.hora_entrada else '—' }}</td>
              <td class="text-danger fw-semibold">{{ r.hora_salida.strftime('%H:%M') if r.hora_salida else '—' }}</td>
              <td>{{ r.docente.jornada }}</td>
            </tr>
          {% else %}
            <tr><td colspan="5" class="text-center text-muted">Sin registros</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Script para recargar automáticamente cada 30 segundos -->
    <script>
      // Función para recargar solo si no hay formularios con cambios pendientes
      function recargarSiSeguro() {
        const forms = document.querySelectorAll('form');
        let formChanged = false;
        
        forms.forEach(form => {
          const elements = form.elements;
          for (let i = 0; i < elements.length; i++) {
            if (elements[i].value !== elements[i].defaultValue) {
              formChanged = true;
              break;
            }
          }
        });

        if (!formChanged) {
          window.location.reload();
        }
      }

      // Recargar cada 30 segundos si no hay cambios pendientes
      setInterval(recargarSiSeguro, 30000);
    </script>

  </div>
</div>
{% endblock %}